#!/bin/python3
# We download the file http://unicode.org/Public/UNIDATA/CaseFolding.txt
# and then use that to generate a table of case folding mappings.

from urllib.request import urlopen
import argparse

def get_data(url):
    """
    Download the data from the given url.
    """
    return urlopen(url).read().decode("utf-8")

def download_case_folding_data():
    """
    Download the case folding data from the unicode.org website.
    """
    # Get the data from the unicode.org website.
    url = "http://unicode.org/Public/UNIDATA/CaseFolding.txt"
    data = get_data(url)
    return data

def parse_case_folding_data(data):
    """
    Parse the case folding data.
    """
    # Parse the data.
    lowercaseMappings = {}
    uppercaseMappings = {}
    for line in data.splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        parts = line.split(";")
        if len(parts) < 3:
            continue
        code = int(parts[0].strip(), 16)
        status = parts[1].strip()
        if status != "C":
            continue
        mapping = parts[2].strip()
        if mapping.startswith("<"):
            continue
        lowercaseMappings[int(mapping, 16)] = code
        uppercaseMappings[code] = int(mapping, 16)

    # sort mappings by key
    lowercaseMappings = sorted(lowercaseMappings.items(), key=lambda x: x[0])
    uppercaseMappings = sorted(uppercaseMappings.items(), key=lambda x: x[0])
    return lowercaseMappings, uppercaseMappings

def write_header(outPath):
    """
    Write the header file to a file.
    """
    with open(outPath.replace(".c", ".h"), "w") as f:
        f.write("""\
/*
 * This file is generated by gen_cases.py.
 * Do not edit this file directly.
 */
""")
        f.write("""\

#ifndef DS_CASE_FOLDING_H
#define DS_CASE_FOLDING_H
""")
        f.write("""\

#include <stddef.h>
#include <stdint.h>
""")
        f.write("""\

typedef struct {
    uint32_t code;
    uint32_t folded_code;
} case_folding_t;

""")

        f.write("""\
extern const size_t g_lowerCaseTableSize;
""")
        f.write("""\
extern const case_folding_t g_lowerCaseTable[];

""")
        f.write("""\
extern const size_t g_upperCaseTableSize;
""")
        f.write("""\
extern const case_folding_t g_upperCaseTable[];

""")
        f.write("""\
#endif
""")

def write_table(lcMap, ucMap, outPath):
    """
    Write the table of case folding mappings to a file.
    """
    
    with open(outPath, "w") as f:
        f.write("""\
/*
 * This file is generated by gen_cases.py.
 * Do not edit this file directly.
 */

""")
        headerName = outPath.replace(".c", ".h")
        f.write(f"#include <{headerName}>\n\n")

        f.write(f"const size_t         g_lowerCaseTableSize = {len(lcMap)};\n", )
        f.write("const case_folding_t g_lowerCaseTable[] = {\n")
        f.write("    // uppercase, lowercase\n")
        for code, folded_code in lcMap:
            f.write("    { ")
            f.write("0x{:08x}, 0x{:08x}".format(code, folded_code))
            f.write(" },\n")
        f.write("};\n\n")

        f.write(f"const size_t         g_upperCaseTableSize = {len(ucMap)};\n", )
        f.write("const case_folding_t g_upperCaseTable[] = {\n")
        f.write("    // lowercase, uppercase\n")
        for code, folded_code in ucMap:
            f.write("    { ")
            f.write("0x{:08x}, 0x{:08x}".format(code, folded_code))
            f.write(" },\n")
        f.write("};\n\n")

def main(args):
    """
    Generate the table of case folding mappings.
    """
    data = download_case_folding_data()

    # Parse the data.
    lcMap, ucMap = parse_case_folding_data(data)

    # Write the table to a file.
    write_header(args.out)
    write_table(lcMap, ucMap, args.out)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Installation utilities for building and releasing Vali.')
    parser.add_argument('--out', default="case_folding.c", help='Where to write the output file.')
    args = parser.parse_args()
    main(args)
